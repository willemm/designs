<!DOCTYPE html>
<html>
<head>
    <title>Chip Programming Puzzle</title>
    <meta charset="utf-8">
<style>
table.prog {
    border-collapse: collapse;
}
table.prog td {
    width: 30px;
}
table.prog td div {
    margin: 5px auto;
}
#positions td div {
    border: 4px solid black;
    border-radius: 8px;
    width: 12px;
    height: 12px;
    background-color: #666;
}
#positions td.tape div {
    background-color: #bfb;
}
#positions td.tape.show div {
    background-color: #fff;
}
#connectors div.socket {
    border: 5px solid green;
    border-radius: 20px;
    width: 15px;
    height: 15px;
    background-color: #333;
}

#connectors td {
    position: relative;
}

#connectors div.connection {
    position: absolute;
    z-index: 10;
    top: 12px;
    left: 12px;
    background-color: #8c8;
    border: 4px solid #8c8;
    /*
        @(foreach ($s in 0..30) { $an = $s*[Math]::pi/30; $y = [Math]::sin($an)*100; $x = [Math]::cos($an)*50; "{0:n1}% {1:n1}%" -f ((50-$x), $y) }
          foreach ($s in 30..0) { $an = $s*[Math]::pi/30; $y = [Math]::sin($an)*100; $x = [Math]::cos($an)*50; "calc({0:n1}% + {2:n1}px) calc({1:n1}% - {3:n1}px)" -f ((50-$x), $y, ($x/10), ($y/20)) }) -join ', '
    */
    clip-path: polygon(
    0.0% 0.0%, 0.3% 10.5%, 1.1% 20.8%, 2.4% 30.9%, 4.3% 40.7%, 6.7% 50.0%, 9.5% 58.8%, 12.8% 66.9%, 16.5% 74.3%, 20.6% 80.9%, 25.0% 86.6%, 29.7% 91.4%, 34.5% 95.1%, 39.6% 97.8%, 44.8% 99.5%, 50.0% 100.0%, 55.2% 99.5%, 60.4% 97.8%, 65.5% 95.1%, 70.3% 91.4%, 75.0% 86.6%, 79.4% 80.9%, 83.5% 74.3%, 87.2% 66.9%, 90.5% 58.8%, 93.3% 50.0%, 95.7% 40.7%, 97.6% 30.9%, 98.9% 20.8%, 99.7% 10.5%, 100.0% 0.0%, calc(100.0% + -5.0px) calc(0.0% - 0.0px), calc(99.7% + -5.0px) calc(10.5% - 0.5px), calc(98.9% + -4.9px) calc(20.8% - 1.0px), calc(97.6% + -4.8px) calc(30.9% - 1.5px), calc(95.7% + -4.6px) calc(40.7% - 2.0px), calc(93.3% + -4.3px) calc(50.0% - 2.5px), calc(90.5% + -4.0px) calc(58.8% - 2.9px), calc(87.2% + -3.7px) calc(66.9% - 3.3px), calc(83.5% + -3.3px) calc(74.3% - 3.7px), calc(79.4% + -2.9px) calc(80.9% - 4.0px), calc(75.0% + -2.5px) calc(86.6% - 4.3px), calc(70.3% + -2.0px) calc(91.4% - 4.6px), calc(65.5% + -1.5px) calc(95.1% - 4.8px), calc(60.4% + -1.0px) calc(97.8% - 4.9px), calc(55.2% + -0.5px) calc(99.5% - 5.0px), calc(50.0% + 0.0px) calc(100.0% - 5.0px), calc(44.8% + 0.5px) calc(99.5% - 5.0px), calc(39.6% + 1.0px) calc(97.8% - 4.9px), calc(34.5% + 1.5px) calc(95.1% - 4.8px), calc(29.7% + 2.0px) calc(91.4% - 4.6px), calc(25.0% + 2.5px) calc(86.6% - 4.3px), calc(20.6% + 2.9px) calc(80.9% - 4.0px), calc(16.5% + 3.3px) calc(74.3% - 3.7px), calc(12.8% + 3.7px) calc(66.9% - 3.3px), calc(9.5% + 4.0px) calc(58.8% - 2.9px), calc(6.7% + 4.3px) calc(50.0% - 2.5px), calc(4.3% + 4.6px) calc(40.7% - 2.0px), calc(2.4% + 4.8px) calc(30.9% - 1.5px), calc(1.1% + 4.9px) calc(20.8% - 1.0px), calc(0.3% + 5.0px) calc(10.5% - 0.5px), calc(0.0% + 5.0px) calc(0.0% - 0.0px)
    );
}

#tape {
}
#tape .cell {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid black;
    border-radius: 4px;
    background-color: #fff;
    margin: 2px 1px;
}
#tape .cell_1 {
    background-color: #0ff;
}
#tape .cell_2 {
    background-color: #f0f;
}
#tape .cell_3 {
    background-color: #ff0;
}
.buttons input {
    margin: 5px 2px;
}

#slots td > div {
    border: 3px solid #333;
    border-radius: 5px;
    width: 20px;
    height: 80px;
    background-color: #333;
    text-align: center;
}

#slots td > div > div {
    width: 20px;
    height: 80px;
    padding: 0;
    margin: 0;
}

#slots .card_1 div,
#slots .card_2 div,
#slots .card_3 div {
    content: (" ");
    clip-path: polygon(
        7px 35px,
        7px 25px,
        13px 25px,
        13px 35px,
        20px 35px,
        20px 45px,
        13px 45px,
        13px 55px,
        7px 55px,
        7px 45px,
        0px 45px,
        0px 35px
    );
}

#slots .card_4 div,
#slots .card_5 div,
#slots .card_6 div,
#slots .card_7 div {
    content: (" ");
    clip-path: polygon(
        0px 55px,
        7px 55px,
        7px 40px,
        13px 40px,
        13px 55px,
        20px 55px,
        10px 75px
    );
    
}

#slots .card_1 div {
    background-color: #0ff;
}
#slots .card_2 div {
    background-color: #f0f;
}
#slots .card_3 div {
    background-color: #ff0;
}
#slots .card_4 div {
    background-color: #fff;
}
#slots .card_5 div {
    background-color: #0ff;
}
#slots .card_6 div {
    background-color: #f0f;
}
#slots .card_7 div {
    background-color: #ff0;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
var cols = 32
var tapelen = 32

var slots = []

$(init)

function init()
{
    for (var c = 0; c < cols; c++) {
        slots.push({
            card: 0,
            conns: [],
            tape: null,
            newtape: null
        })
    }
    var html = [[],[],[]]
    for (var s = 0; s < slots.length; s++) {
        html[0].push('<td><div></div></td>')
        html[1].push('<td><div class="slot" myslotidx="'+s+'"><div></div></div></td>')
        html[2].push('<td><div class="socket"></div></td>')
    }
    $('#positions').html(html[0].join(''))
    $('#slots').html(html[1].join(''))
    $('#connectors').html(html[2].join(''))
    html = []
    for (var t = 0; t < tapelen; t++) {
        html.push('<div class="cell"></div>')
    }
    $('#tape').html(html.join(''))

    $('#stepone').click(clickstepone)
    $('#insert').click(clickinsert)

    $('#slots').on('click', 'div.slot', clickslot)
}

function setupprog()
{
    slots[3].card = 3
    slots[5].card = 5
    slots[6].card = 6
    slots[7].card = 7
    slots[8].card = 1
    slots[9].card = 4
    showslot(3)
    showslot(5)
    showslot(6)
    showslot(7)
    showslot(8)
    showslot(9)
    addconn(5,8)
    addconn(9,4)
    addconn(6,4)
    addconn(7,10)
}

function clickslot(e)
{
    var slotidx = parseInt($(this).attr('myslotidx'))
    var slot = slots[slotidx]
    slot.card = (slot.card + 1) % 8
    this.className = "slot card_"+slot.card
}

function showslot(s)
{
    $('#slots td:nth-child('+(s+1)+') div.slot').addClass("card_"+slots[s].card)
}

function clickstepone(e)
{
    stepone()
    e.stopPropagation()
    return false
}

function clickinsert(e)
{
    newtape()
    e.stopPropagation()
    return false
}

function newtape()
{
    var tape = {
        content: [1,2,1,2,1],
        show: true
    }
    slots[0].newtape = tape
}

function stepone()
{
    for (var s = 0; s < slots.length; s++) {
        var slot = slots[s]
        if (slot.tape != null) {
            if (slot.tape.error) {
                console.log("Eating error tape")
                continue
            }
            var tape = slot.tape
            var tgts = [s+1]
            if (slot.card < 4) {
                // Write color
                if (slot.card > 0) {
                    if (tape.content.length < 32) {
                        tape.content.push(slot.card)
                    } else {
                        console.log("Tape overflow")
                    }
                }
            } else {
                var dobranch = true
                if (slot.card > 4) {
                    // Read color
                    var color = tape.content[0]
                    if (color == (slot.card-4)) {
                        tape.content.shift()
                    } else {
                        dobranch = false
                    }
                }
                if (dobranch) {
                    tgts = slot.conns
                }
            }
            if (tgts.length == 0) {
                console.log("Tape disappear?")
            }
            for (t = 0; t < tgts.length; t++) {
                var ns = tgts[t]
                if (ns < slots.length) {
                    if (slots[ns].newtape != null) {
                        console.log("Tape clash")
                        slots[ns].newtape.error = "clash"
                    } else {
                        slots[ns].newtape = tape
                    }
                } else {
                    tapecheck(tape)
                }
            }
        }
    }
    var poss = $('#positions td')
    for (var s = 0; s < slots.length; s++) {
        var slot = slots[s]
        if (slot.newtape) {
            slot.tape = slot.newtape
            if (slot.tape.show) {
                showtape(slot.tape)
                poss[s].className = "tape show"
            } else {
                poss[s].className = "tape"
            }
        } else {
            slot.tape = null
            poss[s].className = ""
        }
        slot.newtape = null
    }
}

function addconn(s1, s2)
{
    if (s1 > s2) {
        var s = s1
        s1 = s2
        s2 = s
    }
    if (slots[s1].conns.includes(s2)) {
        return
    }
    slots[s1].conns.push(s2)
    slots[s2].conns.push(s1)
    var td1 = $('#connectors td:nth-child('+(s1+1)+')')
    var td2 = $('#connectors td:nth-child('+(s2+1)+')')
    var dist = td2.position().left - td1.position().left
    var conn = $('<div class="connection"></div>').appendTo(td1)
    conn.width(dist)
    conn.height(dist/3)
}

function tapecheck(tape)
{
    console.log("TODO check", tape)
}

function showtape(tape)
{
    var tapecells = $('#tape div.cell')
    for (t = 0; t < tapecells.length; t++) {
        if (tape.content[t]) {
            tapecells[t].className = "cell cell_"+tape.content[t]
        } else {
            tapecells[t].className = "cell"
        }
    }
}

</script>
</head>
<body>
    <div class="buttons">
        <input type="button" id="stepone" value="step one">
        <input type="button" id="insert" value="insert">
        <div id="tape"></div>
    </div>
    <table class="prog">
        <tr id="positions"/>
        <tr id="slots"/>
        <tr id="connectors"/>
    </table>
</body>
</html>
